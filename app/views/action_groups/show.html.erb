<% content_for :pageTitle do %>
  <%= t('layout.title.actionGroup', year: @action_group.title) %>
<% end %>

<%
  desc = "Alle Aktionen der Aktionswoche #{@action_group.title} " +
      "vom #{l @action_group.date_range.begin, format: :only_day} bis #{l @action_group.date_range.end, format: :short_date} " +
      "findest du hier.
     Welche Aktion passt zu dir?"
%>

<% content_for :appendToHeader do %>
  <meta name="description" content="<%= desc %>" />
  <meta property="og:image" content="https://www.servethecity-karlsruhe.de/images/share.jpg" />
  <meta property="og:description" content="<%= desc %>" />
<% end %>

<section id="action-list-header" class="showOverflow">

  <div class="select-year">
    <h1>Aktionswoche <%= @action_group.title %></h1>
    <%= render partial: 'layouts/week_dropdown',
               locals: { target_path: lambda { |action_group| show_action_group_path(action_group.title) } } %>
  </div>

  <div style="text-align: right">
    <div class="infobox">
      <% actions_count = @action_group.actions.visible.where.not(desired_team_size: 0).where(parent_action: nil).count %>
      <span><%= actions_count %></span>
      <div><%= Action.model_name.human(count: actions_count) %></div>
    </div>
    <% if @action_group.active_user_count > 0 %>
      <% if current_user&.in_orga_team? %>
        <a href="<%= statistiken_teilnahmen_path %>" style="color: inherit;">
      <% end %>
      <div class="infobox">
        <span><%= @action_group.active_user_count %></span>
        <div><%= t('user.label.countActive') %></div>
      </div>
      <% if current_user&.in_orga_team? %>
        </a>
      <% end %>
    <% end %>
    <% if @action_group.vacancy_count > 0 %>
      <% if current_user&.in_orga_team? %>
        <a href="<%= statistiken_auslastung_path %>" style="color: inherit;">
      <% end %>
      <div class="infobox">
        <span><%= @action_group.vacancy_count %></span>
        <div><%= t('action.label.vacancies') %></div>
      </div>
      <% if current_user&.in_orga_team? %>
        </a>
      <% end %>
    <% end %>
  </div>

  <div class="clearfix"></div>
</section>

<div class="row">

  <div class="col-md-3 col-md-push-9">
    <div class="row row-sm-eq-height row-md-diff-height">

      <section class="col-sm-6 col-md-12 slim">
        <h3>Filtern</h3>
        <%= bootstrap_form_for(:filter, url: actions_path, method:'get', html:{id:'actionFilter'}) do |f| %>
          <%#= collection_select(:week, ActionGroup.all, :id, :title,
                 :include_blank => "- - - Aktionswoche egal - - -") %>
          <%= f.select(:day, options_for_day_select(@action_group), include_blank: "- - - Alle Tage - - -", hide_label: true) %>
          <%= f.select(:status, Action.statuses.keys.map { |s| [t("action.status.#{s}"), s] },
                       include_blank: "- - - Status egal - - -", hide_label: true) %>
          <% if user_signed_in? && current_user.in_orga_team? %>
            <%= f.select(:visibility, [['Sichtbar', :visible], ['Versteckt', :hidden]],
                         include_blank: "- - - Sichtbarkeit egal - - -", hide_label: true) %>
          <% end %>
          <%= f.check_box :after_17h, label: 'Nur Aktionen ab 17 Uhr anzeigen' %>
          <%= f.submit 'Aktionen filtern', class:'btn btn-default btn-wide' %>
          <div id="filterResults"></div>
        <% end %>
      </section>

      <section class="col-sm-6 col-md-12 slim hidden-xs hidden-sm">
        <h3>Eigene Aktion</h3>
        <span><%= t('action.action.wantToStartOwnAction') %></span>
        <%= link_to t('action.action.weHelpYou'),
                    own_action_path, class:'btn btn-default btn-new-action' %>
      </section>

      <% if policy(:action).new? %>
        <section class="col-sm-6 col-md-12 slim hidden-xs hidden-sm">
          <h3>Optionen</h3>
          <%= link_to t('action.action.new'),
                      new_action_path, class:'btn btn-default btn-wide' %>
        </section>
      <% end %>

    </div>
  </div>

  <div class="col-md-9 col-md-pull-3" id="action-list">
    <% @actions.each do |action| %>
      <section class="action">
        <div class="action-title">
          <%= link_to action do %>
            <h2><%= action.title %></h2>
            <% if policy_scope(action.subactions).count > 0 %>
              <h3><%= t('action.label.subactions', count: policy_scope(action.subactions).count) %></h3>
            <% end %>
          <% end %>
        </div>
        <div class="action-image">
          <%= link_to action do %>
            <% if action.show_picture? %>
              <%= image_tag action.picture_url(:action_list), lazy:true %>
            <% else %>
              <%= image_tag 'placeholder.svg' %>
            <% end %>
            <% ext_status = action.visible? ? action.status : :hidden %>
            <div class="action-status status_<%= ext_status %>">
              <%= t "action.status.#{ext_status}" %>
            </div>
          <% end %>
        </div>
        <div class="action-description">
          <% if action.short_description.empty? %>
              <div><%= action.description %></div>
          <% else %>
              <div><%= action.short_description %></div>
          <% end %>
        </div>
      </section>
    <% end %>
    <% if policy_scope(@action_group.actions).toplevel.count == 0 %>
      <section>
        <%= t('action_group.noActions') %>
      </section>
    <% end %>
  </div>

</div>

<section class="visible-xs visible-sm slim">
  <h3>Eigene Aktion</h3>
  <span><%= t('action.action.wantToStartOwnAction') %></span>
  <%= link_to t('action.action.weHelpYou'),
              own_action_path, class:'btn btn-default btn-new-action' %>
</section>

<% if policy(:action).new? %>
    <section class="visible-xs visible-sm slim">
      <h3>Optionen</h3>
      <%= link_to t('action.action.new'),
                  new_action_path, class:'btn btn-default btn-wide' %>
    </section>
<% end %>